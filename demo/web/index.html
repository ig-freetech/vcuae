<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#1f5f4a" />
    <title>Purchase Ledger Demo</title>
    <link rel="manifest" href="./manifest.webmanifest" />
    <link rel="icon" href="./icons/icon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="./icons/icon.svg" />
    <link rel="stylesheet" href="./styles.css" />
    <script src="../shared/ledger-core.js" defer></script>
    <script src="./app.js" defer></script>
  </head>
  <body>
    <main class="shell">
      <header class="hero">
        <p class="hero-kicker">Purchase Ledger Demo</p>
        <h1>Purchase Ledger — Auto-Entry Demo</h1>
        <p>
          Separates customer input and staff review, then auto-appends one row to a Google Spreadsheet.
        </p>
      </header>

      <section class="card settings-card">
        <details id="settings-panel">
          <summary>Connection Settings</summary>

          <!-- Step 1: 接続情報 -->
          <div id="settings-step-1" class="settings-step">
            <h3 class="settings-step-title">
              <span class="step-number">1</span> Connection
            </h3>
            <p class="help-text">Enter the Web App URL and API Key from your Google Apps Script deployment.</p>
            <div class="grid two-col">
              <label>
                <span>Web App URL</span>
                <input id="endpoint" name="endpoint" type="url"
                  placeholder="https://script.google.com/macros/s/.../exec"
                  autocomplete="off" required />
              </label>
              <label>
                <span>API Key</span>
                <input id="api-key" name="apiKey" type="password"
                  placeholder="Value set in Script Properties"
                  autocomplete="off" required />
              </label>
            </div>
            <div class="actions">
              <button id="test-connection" type="button" class="secondary">Test Connection</button>
              <button id="save-settings" type="button" class="secondary">Save Settings</button>
            </div>
            <output id="connection-status" class="status" aria-live="polite"></output>
          </div>

          <!-- Step 2: スプレッドシート設定 (initially hidden) -->
          <div id="settings-step-2" class="settings-step hidden">
            <h3 class="settings-step-title">
              <span class="step-number">2</span> Spreadsheet
            </h3>
            <p class="help-text">
              Enter the URL of the target spreadsheet.
              <br><small>e.g. https://docs.google.com/spreadsheets/d/XXXXX/edit</small>
            </p>
            <label class="full-width">
              <span>Spreadsheet URL</span>
              <input id="spreadsheet-url" name="spreadsheetUrl" type="url"
                placeholder="https://docs.google.com/spreadsheets/d/.../edit"
                autocomplete="off" />
            </label>
            <label>
              <span>Sheet Name</span>
              <select id="sheet-name" name="sheetName" disabled>
                <option value="">-- Select a sheet --</option>
              </select>
            </label>
            <div class="actions">
              <button id="load-sheets" type="button" class="secondary">Load Sheets</button>
              <button id="apply-spreadsheet" type="button" class="secondary">Apply Spreadsheet</button>
            </div>
            <output id="spreadsheet-status" class="status" aria-live="polite"></output>
          </div>

          <!-- Step 3: 列マッピング確認 (initially hidden) -->
          <div id="settings-step-3" class="settings-step hidden">
            <h3 class="settings-step-title">
              <span class="step-number">3</span> Column Mapping
            </h3>
            <div id="column-mapping" class="column-mapping-grid"></div>
            <div id="header-mismatch-warning" class="warning hidden">
              <strong>Warning:</strong> Spreadsheet headers do not match the expected values.
              <pre id="header-diff"></pre>
            </div>
          </div>

          <!-- セットアップガイド -->
          <div class="setup-guide">
            <details>
              <summary>セットアップガイド（日本語スタッフ向け）</summary>
              <ol class="guide-steps">
                <li>
                  <strong>Google Apps Script でプロジェクトを作成</strong>
                  <ul>
                    <li><a href="https://script.google.com" target="_blank" rel="noopener">https://script.google.com</a> にアクセス</li>
                    <li>「新しいプロジェクト」をクリック</li>
                    <li>Code.gs に提供されたスクリプトを貼り付けて保存</li>
                  </ul>
                </li>
                <li>
                  <strong>Script Properties に API_KEY を設定</strong>
                  <ul>
                    <li>左サイドバー「プロジェクトの設定」（⚙ 歯車アイコン）をクリック</li>
                    <li>下部の「スクリプト プロパティを追加」をクリック</li>
                    <li>プロパティ: <code>API_KEY</code>、値: 任意の文字列を入力して保存</li>
                  </ul>
                </li>
                <li>
                  <strong>Web App としてデプロイ</strong>
                  <ul>
                    <li>右上「デプロイ」→「新しいデプロイ」</li>
                    <li>種類の選択で「ウェブアプリ」を選択</li>
                    <li>次のユーザーとして実行: 「自分」</li>
                    <li>アクセスできるユーザー: 「全員」</li>
                    <li>「デプロイ」をクリック → 表示された Web App URL をコピー</li>
                  </ul>
                </li>
                <li>
                  <strong>上の「Connection」に Web App URL と API Key を入力</strong>
                </li>
                <li>
                  <strong>「Test Connection」で接続確認</strong>
                  <ul>
                    <li>成功すると「Spreadsheet」セクションが表示されます</li>
                  </ul>
                </li>
                <li>
                  <strong>「Spreadsheet」で書き込み先を設定</strong>
                  <ul>
                    <li>Spreadsheet URL を入力 →「Load Sheets」→ シートを選択 →「Apply Spreadsheet」</li>
                  </ul>
                </li>
                <li>
                  <strong>「Column Mapping」で全列 ✓ を確認して完了</strong>
                </li>
              </ol>
            </details>
          </div>
        </details>
      </section>

      <section class="card">
        <nav class="stepper" aria-label="Input steps">
          <button id="step-customer" class="step active" type="button">
            1. Customer Info
          </button>
          <button id="step-staff" class="step" type="button" disabled>
            2. Staff Review
          </button>
        </nav>

        <form id="ledger-form" novalidate>
          <section id="pane-customer" class="pane active">
            <h2>Customer Input</h2>
            <div class="grid two-col">
              <label>
                <span>Customer Name <span class="col-badge">C</span></span>
                <input name="customerName" required autocomplete="name" />
              </label>
              <label>
                <span>Gender <span class="col-badge">D</span></span>
                <select id="gender" name="gender" required></select>
              </label>
              <label>
                <span>Birthday <span class="col-badge">E</span></span>
                <input name="birthday" type="date" required />
              </label>
              <label>
                <span>Mobile Number <span class="col-badge">G</span></span>
                <input
                  name="mobileNumber"
                  type="tel"
                  inputmode="tel"
                  required
                  autocomplete="tel"
                />
              </label>
              <label>
                <span>Email (optional) <span class="col-badge">H</span></span>
                <input name="email" type="email" autocomplete="email" />
              </label>
              <label>
                <span>Country <span class="col-badge">L</span></span>
                <input
                  id="country"
                  name="country"
                  list="country-list"
                  required
                  autocomplete="country-name"
                />
                <datalist id="country-list"></datalist>
              </label>
              <label class="full">
                <span>Address <span class="col-badge">I</span></span>
                <textarea
                  name="address"
                  rows="2"
                  required
                  autocomplete="street-address"
                ></textarea>
              </label>
              <label>
                <span>CsCategory <span class="col-badge">B</span></span>
                <select id="cs-category" name="csCategory" required></select>
              </label>
              <div class="derived">
                <p>Age <span class="col-badge">F</span>: <strong id="derived-age">-</strong></p>
                <p>Birth Month <span class="col-badge">P</span>: <strong id="derived-month">-</strong></p>
                <p>Country (JP) <span class="col-badge">M</span>: <strong id="derived-country-jp">-</strong></p>
                <p>Continent <span class="col-badge">N</span>: <strong id="derived-continent">-</strong></p>
                <p>Subregion <span class="col-badge">O</span>: <strong id="derived-subregion">-</strong></p>
              </div>
            </div>
            <div class="actions">
              <button id="next-btn" type="button">Next: Staff Review</button>
            </div>
          </section>

          <section id="pane-staff" class="pane">
            <h2>Staff Input</h2>
            <div class="grid two-col">
              <label>
                <span>Visit Date <span class="col-badge">A</span></span>
                <input name="visitDate" type="date" required />
              </label>
              <label>
                <span>REF (optional) <span class="col-badge">J</span></span>
                <input name="ref" autocomplete="off" />
              </label>
              <label>
                <span>Payment Method <span class="col-badge">K</span></span>
                <select id="payment-method" name="paymentMethod" required></select>
              </label>
              <label>
                <span>Total Purchase <span class="col-badge">Q</span></span>
                <input
                  name="totalPurchase"
                  type="text"
                  inputmode="decimal"
                  required
                  placeholder="e.g. 1200"
                />
              </label>
              <label>
                <span>Grand Total <span class="col-badge">R</span></span>
                <input
                  name="grandTotal"
                  type="text"
                  inputmode="decimal"
                  required
                  placeholder="e.g. 1200"
                />
              </label>
            </div>
            <div class="actions split">
              <button id="back-btn" type="button" class="secondary">
                Back
              </button>
              <button id="submit-btn" type="submit">Submit to Spreadsheet</button>
            </div>
          </section>
        </form>

        <output id="status" class="status" aria-live="polite"></output>
      </section>
    </main>
  </body>
</html>
