<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#06162c" />
    <title>Purchase Ledger</title>
    <link rel="manifest" href="./manifest.webmanifest" />
    <link rel="icon" href="./icons/icon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="./icons/icon.svg" />
    <link rel="stylesheet" href="./styles.css" />
    <script src="../shared/ledger-core.js" defer></script>
    <script src="./app.js" defer></script>
  </head>
  <body>
    <main class="shell">
      <!-- === Main View (customer-facing) === -->
      <div id="main-view" class="view active">
        <header class="hero">
          <p class="hero-kicker">Purchase Ledger</p>
          <h1>Purchase Ledger</h1>
        </header>

        <!-- Config not-set banner (hidden by default) -->
        <div id="config-banner" class="config-banner hidden">
          <span>&#9881;</span>
          <span>Connection not configured. Tap the gear icon to set up.</span>
        </div>

        <section class="card workflow-card">
          <nav class="stepper" aria-label="Input steps">
            <button id="step-customer" class="step active" type="button">
              1. Customer Info
            </button>
            <button id="step-staff" class="step" type="button" disabled>
              2. Staff Review
            </button>
          </nav>

          <form id="ledger-form" novalidate>
            <section id="pane-customer" class="pane active">
              <h2>Customer Input</h2>
              <div class="grid two-col">
                <label>
                  <span>Customer Name <span class="col-badge">C</span></span>
                  <input name="customerName" required autocomplete="name" />
                </label>
                <label>
                  <span>Gender <span class="col-badge">D</span></span>
                  <select id="gender" name="gender" required></select>
                </label>
                <label>
                  <span>Birthday <span class="col-badge">E</span></span>
                  <input name="birthday" type="date" required />
                </label>
                <label>
                  <span>Mobile Number <span class="col-badge">G</span></span>
                  <input
                    name="mobileNumber"
                    type="tel"
                    inputmode="tel"
                    required
                    autocomplete="tel"
                  />
                </label>
                <label>
                  <span>Email (optional) <span class="col-badge">H</span></span>
                  <input name="email" type="email" autocomplete="email" />
                </label>
                <label>
                  <span>Country <span class="col-badge">L</span></span>
                  <input
                    id="country"
                    name="country"
                    list="country-list"
                    required
                    autocomplete="country-name"
                  />
                  <datalist id="country-list"></datalist>
                </label>
                <label class="full">
                  <span>Address <span class="col-badge">I</span></span>
                  <textarea
                    name="address"
                    rows="2"
                    required
                    autocomplete="street-address"
                  ></textarea>
                </label>
                <label>
                  <span>CsCategory <span class="col-badge">B</span></span>
                  <select id="cs-category" name="csCategory" required></select>
                </label>
                <div class="derived">
                  <p>Age <span class="col-badge">F</span>: <strong id="derived-age">-</strong></p>
                  <p>Birth Month <span class="col-badge">P</span>: <strong id="derived-month">-</strong></p>
                  <p>Country (JP) <span class="col-badge">M</span>: <strong id="derived-country-jp">-</strong></p>
                  <p>Continent <span class="col-badge">N</span>: <strong id="derived-continent">-</strong></p>
                  <p>Subregion <span class="col-badge">O</span>: <strong id="derived-subregion">-</strong></p>
                </div>
              </div>
              <div class="actions">
                <button id="next-btn" type="button">Next: Staff Review</button>
              </div>
            </section>

            <section id="pane-staff" class="pane">
              <h2>Staff Input</h2>
              <div class="grid two-col">
                <label>
                  <span>Visit Date <span class="col-badge">A</span></span>
                  <input name="visitDate" type="date" required />
                </label>
                <label>
                  <span>REF (optional) <span class="col-badge">J</span></span>
                  <input name="ref" autocomplete="off" />
                </label>
                <label>
                  <span>Payment Method <span class="col-badge">K</span></span>
                  <select id="payment-method" name="paymentMethod" required></select>
                </label>
                <label>
                  <span>Total Purchase <span class="col-badge">Q</span></span>
                  <input
                    name="totalPurchase"
                    type="text"
                    inputmode="decimal"
                    required
                    placeholder="e.g. 1200"
                  />
                </label>
                <label>
                  <span>Grand Total <span class="col-badge">R</span></span>
                  <input
                    name="grandTotal"
                    type="text"
                    inputmode="decimal"
                    required
                    placeholder="e.g. 1200"
                  />
                </label>
              </div>
              <div class="actions split">
                <button id="back-btn" type="button" class="secondary">
                  Back
                </button>
                <button id="submit-btn" type="submit">Submit to Spreadsheet</button>
              </div>
            </section>
          </form>

          <output id="status" class="status" aria-live="polite"></output>
        </section>
      </div>

      <!-- === Settings View (staff-facing) === -->
      <div id="settings-view" class="view">
        <header class="hero">
          <button id="back-to-main" class="back-link" type="button">&#8592; Back</button>
          <h1>Configuration</h1>
          <p>Set up your connection and spreadsheet integration</p>
        </header>

        <section class="card settings-card">
          <!-- Step 1: Connection -->
          <div id="settings-step-1" class="settings-step">
            <h3 class="settings-step-title">
              <span class="step-number">1</span> Connection
            </h3>
            <p class="help-text">Enter the Web App URL and Self-Generated Token from your Google Apps Script deployment.</p>
            <div class="grid two-col">
              <label>
                <span>Web App URL</span>
                <input id="endpoint" name="endpoint" type="url"
                  placeholder="https://script.google.com/macros/s/.../exec"
                  autocomplete="off" required />
              </label>
              <label>
                <span>Self-Generated Token</span>
                <input id="self-generated-token" name="selfGeneratedToken" type="password"
                  placeholder="Value set in Script Properties: SELF_GENERATED_TOKEN"
                  autocomplete="off" required />
              </label>
            </div>
            <div class="actions">
              <button id="test-connection" type="button" class="secondary">Test Connection</button>
              <button id="save-settings" type="button" class="secondary">Save Settings</button>
            </div>
            <output id="connection-status" class="status" aria-live="polite"></output>
          </div>

          <!-- Step 2: Spreadsheet (initially hidden) -->
          <div id="settings-step-2" class="settings-step hidden">
            <h3 class="settings-step-title">
              <span class="step-number">2</span> Spreadsheet
            </h3>
            <p class="help-text">
              Enter the URL of the target spreadsheet.
              <br><small>e.g. https://docs.google.com/spreadsheets/d/XXXXX/edit</small>
            </p>
            <label class="full-width">
              <span>Spreadsheet URL</span>
              <input id="spreadsheet-url" name="spreadsheetUrl" type="url"
                placeholder="https://docs.google.com/spreadsheets/d/.../edit"
                autocomplete="off" />
            </label>
            <label>
              <span>Sheet Name</span>
              <select id="sheet-name" name="sheetName" disabled>
                <option value="">-- Select a sheet --</option>
              </select>
            </label>
            <div class="actions">
              <button id="load-sheets" type="button" class="secondary">Load Sheets</button>
              <button id="apply-spreadsheet" type="button" class="secondary">Apply Spreadsheet</button>
            </div>
            <output id="spreadsheet-status" class="status" aria-live="polite"></output>
          </div>

          <!-- Step 3: Column Mapping (initially hidden) -->
          <div id="settings-step-3" class="settings-step hidden">
            <h3 class="settings-step-title">
              <span class="step-number">3</span> Column Mapping
            </h3>
            <div id="column-mapping" class="column-mapping-grid"></div>
            <div id="header-mismatch-warning" class="warning hidden">
              <strong>Warning:</strong> Spreadsheet headers do not match the expected values.
              <pre id="header-diff"></pre>
            </div>
          </div>

          <!-- Setup Guide -->
          <div class="setup-guide">
            <details>
              <summary>セットアップガイド（日本語スタッフ向け）</summary>
              <ol class="guide-steps">
                <li>
                  <strong>Google Apps Script でプロジェクトを作成</strong>
                  <ul>
                    <li><a href="https://script.google.com" target="_blank" rel="noopener">https://script.google.com</a> にアクセス</li>
                    <li>「新しいプロジェクト」をクリック</li>
                    <li>Code.gs に<a href="https://github.com/ig-freetech/vcuae/blob/main/demo/apps-script/Code.gs" target="_blank" rel="noopener">提供されたスクリプト</a>を貼り付けて保存</li>
                  </ul>
                </li>
                <li>
                  <strong>Script Properties に SELF_GENERATED_TOKEN を設定</strong>
                  <ul>
                    <li>左サイドバー「プロジェクトの設定」（&#9881; 歯車アイコン）をクリック</li>
                    <li>下部の「スクリプト プロパティを追加」をクリック</li>
                    <li>プロパティ: <code>SELF_GENERATED_TOKEN</code></li>
                    <li>値: 推測されにくいランダム文字列を設定（パスワードジェネレーター等で32文字以上推奨）</li>
                  </ul>
                </li>
                <li>
                  <strong>Web App としてデプロイ</strong>
                  <ul>
                    <li>右上「デプロイ」→「新しいデプロイ」</li>
                    <li>種類の選択で「ウェブアプリ」を選択</li>
                    <li>次のユーザーとして実行: 「自分」</li>
                    <li>アクセスできるユーザー: 「全員」</li>
                    <li>「デプロイ」をクリック → 表示された Web App URL をコピー</li>
                  </ul>
                </li>
                <li>
                  <strong>上の「Connection」に Web App URL と Self-Generated Token を入力</strong>
                </li>
                <li>
                  <strong>「Test Connection」で接続確認</strong>
                  <ul>
                    <li>成功すると「Spreadsheet」セクションが表示されます</li>
                  </ul>
                </li>
                <li>
                  <strong>「Spreadsheet」で書き込み先を設定</strong>
                  <ul>
                    <li>Spreadsheet URL を入力 →「Load Sheets」→ シートを選択 →「Apply Spreadsheet」</li>
                  </ul>
                </li>
                <li>
                  <strong>「Column Mapping」で全列 &#10003; を確認して完了</strong>
                </li>
              </ol>
            </details>
          </div>
        </section>

        <div class="settings-footer">
          <button id="back-to-main-bottom" type="button" class="secondary">Back to Ledger</button>
        </div>
      </div>

      <!-- Gear FAB (visible on main view only) -->
      <button id="gear-btn" class="gear-fab" type="button" aria-label="Settings">
        <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
          <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
        </svg>
      </button>
    </main>
  </body>
</html>
