<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#06162c" />
    <title>VC Ledger Admin</title>
    <link rel="manifest" href="./manifest.webmanifest" />
    <link rel="icon" href="../assets/VC_logo_blue.webp" type="image/webp" />
    <link rel="apple-touch-icon" href="../assets/VC_logo_blue.webp" />
    <link rel="stylesheet" href="./styles.css" />
    <script src="../shared/ledger-core.js" defer></script>
    <script src="./app.js" defer></script>
  </head>
  <body>
    <main class="shell">
      <header class="hero">
        <p class="hero-kicker">VC Ledger</p>
        <h1>Administration</h1>
        <p>Unlock to manage connection and spreadsheet integration.</p>
      </header>

      <section id="admin-lock" class="card settings-card">
        <h3 class="settings-step-title">
          <span class="step-number">0</span> Admin Unlock
        </h3>
        <p id="unlock-help-initial" class="help-text">
          First time on this browser: enter Web App URL, Self-Generated Token, and
          <code>ADMIN_PASSCODE</code>. URL and Token are saved for next sessions.
        </p>
        <p id="unlock-help-saved" class="help-text hidden">
          Saved URL and Token found on this browser. Enter only <code>ADMIN_PASSCODE</code>.
        </p>
        <div class="grid two-col">
          <label id="unlock-endpoint-field">
            <span>Web App URL</span>
            <input
              id="unlock-endpoint"
              type="url"
              placeholder="https://script.google.com/macros/s/.../exec"
              autocomplete="off"
              required
            />
          </label>
          <label id="unlock-token-field">
            <span>Self-Generated Token</span>
            <input
              id="unlock-token"
              type="password"
              placeholder="SELF_GENERATED_TOKEN"
              autocomplete="off"
              required
            />
          </label>
          <label class="full-width">
            <span>Admin Passcode</span>
            <input
              id="unlock-passcode"
              type="password"
              placeholder="ADMIN_PASSCODE"
              autocomplete="off"
              required
            />
          </label>
        </div>
        <div class="actions">
          <button id="unlock-admin" type="button">Unlock Administration</button>
        </div>
        <output id="unlock-status" class="status" aria-live="polite"></output>

        <div id="unlock-setup-guide" class="setup-guide">
          <details>
            <summary>Setup Guide (shown on first visit only)</summary>
            <ol class="guide-steps">
              <li class="guide-step-item">
                <strong>Step 1: Create a Google Apps Script project</strong>
                <p class="guide-desc">
                  Go to <a href="https://script.google.com" target="_blank" rel="noopener">script.google.com</a>
                  and click "New project".
                </p>
              </li>
              <li class="guide-step-item">
                <strong>Step 2: Paste Code.gs</strong>
                <p class="guide-desc">
                  Click the button below to copy the Code.gs contents, then paste them into the Apps Script editor and save.
                </p>
                <div class="guide-action">
                  <button id="copy-code-gs" type="button" class="secondary guide-btn">
                    <span class="guide-btn-icon">&#128203;</span> Copy Code.gs
                  </button>
                  <span id="copy-code-gs-status" class="guide-status"></span>
                </div>
              </li>
              <li class="guide-step-item">
                <strong>Step 3: Generate a token and set Script Properties</strong>
                <p class="guide-desc">
                  Click the button below to generate and copy a random <code>SELF_GENERATED_TOKEN</code>.
                  Also add <code>ADMIN_PASSCODE</code> (any value you choose) to Script Properties.
                </p>
                <div class="guide-action">
                  <button id="generate-token" type="button" class="secondary guide-btn">
                    <span class="guide-btn-icon">&#128272;</span> Generate &amp; Copy Token
                  </button>
                  <span id="generate-token-status" class="guide-status"></span>
                </div>
              </li>
              <li class="guide-step-item">
                <strong>Step 4: Deploy as Web App</strong>
                <p class="guide-desc">
                  In Apps Script, click "Deploy" &rarr; "New deployment" &rarr; Type: "Web app".
                  Set <strong>Execute as</strong>: "Me" and <strong>Who has access</strong>: "Anyone".
                </p>
                <p class="guide-desc" style="font-size:0.85em;opacity:0.85;">
                  Why "Me"? If you choose "User accessing the web app", every user needs a Google login and spreadsheet permissions &mdash; impractical for shared tablets in a store.
                </p>
              </li>
              <li class="guide-step-item">
                <strong>Step 5: Unlock (first-time authentication)</strong>
                <p class="guide-desc">
                  Enter the Web App URL, Self-Generated Token, and Admin Passcode above to unlock.
                </p>
              </li>
              <li class="guide-step-item">
                <strong>Step 6: Connection &rarr; Spreadsheet &rarr; Google Drive &rarr; Column Mapping</strong>
                <p class="guide-desc">
                  Click Connect, then configure Spreadsheet (Load Sheets &rarr; Apply), configure Google Drive folder (Apply), and finally verify all columns show &#10003; in Column Mapping.
                </p>
              </li>
            </ol>

            <h4 style="margin:1em 0 0.5em;">Troubleshooting</h4>
            <ul class="guide-steps" style="list-style:none;padding-left:0;">
              <li class="guide-step-item">
                <code>CONFIG_ERROR: ADMIN_PASSCODE is not configured</code>
                <p class="guide-desc">Add <code>ADMIN_PASSCODE</code> to Script Properties and save.</p>
              </li>
              <li class="guide-step-item">
                <code>AUTH_ERROR: Invalid self-generated token</code>
                <p class="guide-desc">The token entered here does not match <code>SELF_GENERATED_TOKEN</code> in Script Properties.</p>
              </li>
              <li class="guide-step-item">
                <code>AUTH_ERROR: Invalid admin passcode</code>
                <p class="guide-desc">The passcode entered here does not match <code>ADMIN_PASSCODE</code> in Script Properties.</p>
              </li>
              <li class="guide-step-item">
                <code>CONFIG_ERROR: Google Drive folder is not configured</code>
                <p class="guide-desc">Set a Google Drive Folder URL in Step 6 and click "Apply" in the Google Drive section.</p>
              </li>
            </ul>

            <h4 style="margin:1em 0 0.5em;">Updating Code</h4>
            <ol class="guide-steps">
              <li class="guide-step-item">
                <p class="guide-desc">Update Code.gs in the Apps Script editor and save.</p>
              </li>
              <li class="guide-step-item">
                <p class="guide-desc">"Deploy" &rarr; "Manage deployments" &rarr; Edit &rarr; select "New version" &rarr; re-deploy. The URL stays the same.</p>
              </li>
            </ol>
          </details>
        </div>
      </section>

      <div id="admin-panel" class="hidden">
        <section class="card settings-card">
          <div id="settings-step-1" class="settings-step">
            <h3 class="settings-step-title">
              <span class="step-number">1</span> Connection
            </h3>
            <p class="help-text">
              Enter the Web App URL and Self-Generated Token from your Google Apps Script deployment.
            </p>
            <div class="grid two-col">
              <label>
                <span>Web App URL</span>
                <input
                  id="endpoint"
                  name="endpoint"
                  type="url"
                  placeholder="https://script.google.com/macros/s/.../exec"
                  autocomplete="off"
                  required
                />
              </label>
              <label>
                <span>Self-Generated Token</span>
                <input
                  id="self-generated-token"
                  name="selfGeneratedToken"
                  type="password"
                  placeholder="Value set in Script Properties: SELF_GENERATED_TOKEN"
                  autocomplete="off"
                  required
                />
              </label>
            </div>
            <div class="actions">
              <button id="test-connection" type="button" class="btn-connect">Connect</button>
              <button id="save-settings" type="button" class="secondary">Save Settings</button>
            </div>
            <output id="connection-status" class="status" aria-live="polite"></output>
          </div>

          <div id="settings-step-2" class="settings-step hidden">
            <h3 class="settings-step-title">
              <span class="step-number">2</span> Spreadsheet
            </h3>
            <p class="help-text">
              Select where customer submission rows are written in Google Spreadsheet.
              <br /><small>Paste a Spreadsheet URL, load available sheets, then choose one target sheet.</small>
            </p>
            <label class="full-width">
              <span>Spreadsheet URL</span>
              <input
                id="spreadsheet-url"
                name="spreadsheetUrl"
                type="url"
                placeholder="https://docs.google.com/spreadsheets/d/.../edit"
                autocomplete="off"
              />
            </label>
            <div class="actions">
              <button id="load-sheets" type="button" class="btn-load-sheets">Load Sheets</button>
            </div>
            <div id="sheet-config-panel" class="sheet-config-panel hidden">
              <label>
                <span>Sheet Name</span>
                <select id="sheet-name" name="sheetName" disabled>
                  <option value="">-- Select a sheet --</option>
                </select>
              </label>
              <div class="actions">
                <button id="apply-spreadsheet" type="button" class="btn-apply">Apply</button>
              </div>
            </div>
            <output id="spreadsheet-status" class="status" aria-live="polite"></output>
          </div>

          <div id="settings-step-3" class="settings-step hidden">
            <h3 class="settings-step-title">
              <span class="step-number">3</span> Google Drive
            </h3>
            <p class="help-text">
              Certificate photos are stored in this Google Drive folder.
              <br /><small>Set a folder URL that can be accessed by the deployed Apps Script account.</small>
            </p>
            <label class="full-width">
              <span>Google Drive Folder URL (for certificate photos)</span>
              <input
                id="drive-folder-url"
                name="driveFolderUrl"
                type="url"
                placeholder="https://drive.google.com/drive/folders/..."
                autocomplete="off"
              />
            </label>
            <div class="actions">
              <button id="apply-drive" type="button" class="btn-apply">Apply</button>
            </div>
            <output id="drive-status" class="status" aria-live="polite"></output>
          </div>

          <div id="settings-step-4" class="settings-step hidden">
            <h3 class="settings-step-title">
              <span class="step-number">4</span> Column Mapping
            </h3>
            <div id="column-mapping" class="column-mapping-grid"></div>
            <div id="header-mismatch-warning" class="warning hidden">
              <strong>Warning:</strong> Spreadsheet headers do not match the expected values.
              <pre id="header-diff"></pre>
            </div>
          </div>

        </section>

        <div class="settings-footer">
          <button id="lock-admin" type="button" class="secondary">Lock Administration</button>
        </div>
      </div>
    </main>
  </body>
</html>
