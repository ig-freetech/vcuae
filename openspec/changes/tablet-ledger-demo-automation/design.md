## Context

現行業務は紙台帳への手書き入力後、スタッフが Google スプレッドシートへ手入力転記している。  
デモの制約は以下:

- 追加のクラウドサーバーは持たない（無料運用を優先）
- 店舗のタブレットで操作できること
- 既存のスプレッドシート列構造を維持すること
- デモ段階は常時オンライン前提で実装速度を優先すること

ステークホルダーは、店舗スタッフ、顧客（タブレット入力）、運用責任者（シート確認）。

## Goals / Non-Goals

**Goals:**

- 顧客入力とスタッフ確認を分離した 2 ステップ入力フローを提供する。
- Google Apps Script Web App 経由で 1 レコードをスプレッドシートに自動追記する。
- `Age`、`誕生月`、`CountryJP`、`Continent大陸`、`Subregion小地域` を自動計算/補完する。
- バリデーション不備・二重送信を防ぎ、手転記を不要にする。
- OpenSpec と TDD で実装範囲と受け入れ条件を固定化する。

**Non-Goals:**

- OCR による紙台帳読み取り
- 本人確認書類（ID画像）の撮影・保存
- 完全オフライン同期
- 本番用の監視基盤や高度な認可管理

## Decisions

1. **アーキテクチャは `Tablet Web App + Apps Script + Google Sheets` を採用する**
   - 理由: 追加サーバーなしで即時にデモ提供でき、運用負荷を最小化できる。
   - 代替案:
     - 直接 Sheets API: OAuth 管理が重く、デモには過剰
     - 独自バックエンド: コスト・保守が増える

2. **入力責務を 2 段階に分割する**
   - 1段階目: 顧客が個人情報/基本情報を入力
   - 2段階目: スタッフが会計/確定項目を入力して送信
   - 理由: 入力効率と業務統制を両立し、誤入力責任範囲を明確にできる。
   - 代替案:
     - 顧客全入力: 査定/会計項目の誤入力リスク増
     - スタッフ全入力: 効率化効果が小さい

3. **派生項目は共通ロジックで自動算出する**
   - 対象: `Age`, `誕生月`, `CountryJP`, `Continent大陸`, `Subregion小地域`
   - 理由: 手入力ミスを削減し、フロント/Apps Script間で同一計算規則を保てる。
   - 代替案:
     - シート数式依存: フォーマット変更時の破損リスクと可観測性低下

4. **セキュリティはデモ最小構成として API キー照合を採用する**
   - 理由: Apps Script 公開時の無関係アクセスを抑止しつつ導入が簡易。
   - 代替案:
     - OAuth/OIDC: 実装コストが高くデモの主目的から逸れる

5. **TDDの単位を shared logic / web flow / apps-script endpoint の3層で分離する**
   - 理由: 純粋関数（shared）を先に固め、I/O境界（web/apps-script）を後段で検証する方がデバッグ効率が高い。

## Risks / Trade-offs

- **[Risk] 国情報辞書の不足で `N/A` が増える**  
  → Mitigation: デモ利用国を初期辞書に追加し、未定義国入力をログ出力する。

- **[Risk] Apps Script の実行エラー/レート制限**  
  → Mitigation: エラーコードをクライアントへ返し、再送手順を UI に明示する。

- **[Risk] デモで API キー露出の懸念**  
  → Mitigation: Script Properties 管理とデモ用キー分離、定期ローテーションを運用手順に含める。

- **[Trade-off] 常時オンライン前提のため通信断時の継続入力は不可**  
  → Mitigation: 将来フェーズで PWA オフラインキューを追加予定として切り分ける。

- **[Trade-off] 本番運用向け監査ログは未実装**  
  → Mitigation: 今回はシート追記ログを一次監査とし、本番化時に拡張する。
